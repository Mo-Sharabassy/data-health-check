# Data Health Check

I work with data that requires manual input, and I faced difficulties in tracking updates due to the limitations of the version table. To address this, I developed a customized process for performing data health checks and meticulously monitoring updates. Here's the technical approach I implemented.

The core of the Data Health Check process involves comparing the data retrieved from the Metabase every two hours with the locked data from 24 hours ago. This is achieved through the following steps:
---

## Data Retrieval and Update

To automate data retrieval and updates, we use triggers and the following steps:

1. **Data Retrieval**: We pull the data from Metabase and update it every two hours. This is done using the integration provided by the Metabase-Google Sheets add-on.

2. **Backup Data**: In a separate sheet, we generate tabs D1 to D(end of month) and create a query to pull data from yesterday. This ensures that we lock in the data after 24 hours.

## Metabase Integration

**Data Retrieval**: We pull the data from Metabase and update it every two hours. This is done using the integration provided by the Metabase-Google Sheets add-on.

The Metabase integration can be found in the `Health_Check` folder in `import_updated_data.js`. To use it, follow these steps:

1. Go to the Google Apps Script settings.

2. Add the following script properties:

   - **USERNAME**: YOUR_USER_NAME
   - **PASSWORD**: YOUR_PASSWORD
   - **BASE_URL**: YOUR_METABASE_URL

This will fetch the token that will be used for the entire script to extract data.

If you want to set a trigger to import automateimport the data you have to name the tab in this format : (metabase/QUESTION_NUMBER)

## Generating Backup Tabs

**Backup Data**: In a separate sheet, we generate tabs D1 to D(end of month) and create a query to pull data from yesterday. This ensures that we lock in the data after 24 hours.

The `generateTabs()` function serves the purpose of generating backup tabs in your Google Sheets document. These tabs are intended for data storage and backup. Below is the documentation for this function:

**Function Name**: `generateTabs()`

**Purpose**: This function automates the process of creating backup tabs within your Google Sheets document. It is particularly useful for scenarios where you need to maintain historical data, such as daily backups.

**Usage**:
- Make sure to open your desired Google Sheets document.
- In the function, you can specify the target sheet by modifying the line:
  ```javascript
  var sheet = spreadsheet.getSheetByName('Sheet1'); // Change 'Sheet1' to the name of your desired sheet

## Updated Metabase Integration

I've made an update to the Metabase Integration script located in the `backup_sheet` folder. In this update, we have a function called `automateImportLOL()` which automates the data import process. Instead of providing the actual code, I'll document its purpose and usage:

**Function Name**: `automateImportLOL()`

**Purpose**: This function automates the import of data from Metabase to the specified Google Sheets tab. It ensures that the data from a specific Metabase question (identified by QUESTION_NUMBER) is imported into the corresponding tab generated by backup tabs named after the previous day's date (e.g., 'D1' for the previous day).

**Usage**:
- The `currentDate` and `previousDate` variables are used to determine the date of the previous day.
- The `sheetName` variable is generated to specify the tab where the data will be imported (e.g., 'D1' for the previous day's data).
- The `getQuestionAsCSV()` function is called to import the data. If successful, a success message is logged; otherwise, an error message is logged.

## Highlight Different Trips and Copy

**Data Comparison**: We apply a Google Query function to append all the data from each day's tab into one consolidated location for easy comparison.

**Conditional Formatting**: To highlight discrepancies or changes in the data, we apply conditional formatting.

**Data Copying**: The compared data is copied into a third tab in the 'Health Check' sheet for further analysis.

The `highlightDifferentTripsAndCopy()` function is designed to highlight and copy different trips between two sheets and then store these differences in an "Edited Trips" sheet. Below is the documentation for this function:

**Function Name**: `highlightDifferentTripsAndCopy()`

**Purpose**: This function performs the following operations:
- Retrieves data from two sheets named "(metabase/4037)" and "day_to_day_data."
- Compares the data and identifies differences between trips based on their unique IDs.
- Highlights the differing cells and copies the trips to the "Edited Trips" sheet.

**Usage**:
1. Make sure you have two sheets named "(metabase/QUESTION_NUMBER)" and "day_to_day_data" containing trip data.
2. Call the `highlightDifferentTripsAndCopy()` function to identify and copy differing trips.

Here is a breakdown of the steps within the function:

- `clearSheetFormatting(sheet)`: Clears existing formatting in the "(metabase/QUESTION_NUMBER)" sheet.

- `clearSheetContentsAndFormatting(sheet)`: Clears existing contents and formatting in the "Edited Trips" sheet starting from the second row.

- `areTripsDifferent(trip1, trip2)`: Compares two trips based on their values and returns `true` if they are different.

- `highlightAndCopyTrips(sheet1, sheet2, editedTripsSheet, i, j, trip1, trip2)`: Highlights differing cells and copies the trips to the "Edited Trips" sheet.

- `copyTripWithFormatting(sourceSheet, targetSheet, rowIndex)`: Copies a trip with formatting from the source sheet to the target sheet.

---
## Conclusion

Our Data Health Check system is a comprehensive approach to maintaining data accuracy and reliability. By following the steps and using the provided functions, you can ensure that your data remains consistent, errors are identified, and changes are highlighted for further analysis.